@startuml forgot-password-sequence-diagram
!theme plain
title Diagrama de Secuencia - Recuperación de Contraseña (Olvidé mi contraseña)

actor Cliente as C
participant "AuthController" as AC
participant "AuthService" as AS
participant "UsersService" as US
participant "TokensService" as TS
participant "AuthEmailService" as AES
database "Base de Datos" as BD
participant "Servicio de Email\n(SMTP)" as EMAIL

note over C, EMAIL
    Flujo completo de recuperación de contraseña
    Incluye: solicitud, validación de token y actualización de contraseña
end note

== Fase 1: Solicitud de Recuperación ==

C -> AC: POST /auth/forgot-password\n{ForgotPasswordDto: email}
activate AC

AC -> AS: forgotPassword(forgotPasswordDto)
activate AS

note over AS
    Extraer email del DTO
end note

AS -> US: findByEmail(email)
activate US
US -> BD: SELECT * FROM user\nWHERE email = ?
activate BD
BD --> US: User | null
deactivate BD
US --> AS: user
deactivate US

alt user == null
    AS --> AC: NotFoundException\n"El Usuario no existe"
    AC --> C: HTTP 404\n"El Usuario no existe"
else Usuario válido
    note over AS
        Generar token de recuperación
        de 6 dígitos aleatorio
    end note
    
    AS -> AS: generateToken()
    AS -> TS: create({token, userId})
    activate TS
    TS -> BD: INSERT INTO token\n(token, userId, createdAt, expiresAt)
    activate BD
    
    note over TS, BD
        Token expira en 10 minutos
    end note
    
    BD --> TS: Token creado
    deactivate BD
    TS --> AS: tokenRecord
    deactivate TS
    
    AS -> AES: sendPasswordResetToken({email, name, token})
    activate AES
    
    note over AES
        Generar template HTML
        de recuperación de contraseña
        con token incluido
    end note
    
    AES -> EMAIL: Enviar email de recuperación
    activate EMAIL
    EMAIL --> AES: Email enviado
    deactivate EMAIL
    AES --> AS: Email recuperación enviado
    deactivate AES
    
    AS --> AC: "Instrucciones de recuperación enviadas.\nRevisa tu email para restablecer\ntu contraseña de forma segura."
    AC --> C: HTTP 200\nMensaje de éxito
end

deactivate AS
deactivate AC

== Fase 2: Validación del Token ==

C -> AC: POST /auth/validate-token\n{ValidateTokenDto: token}
activate AC

AC -> AS: validateToken(validateTokenDto)
activate AS

AS -> TS: findByToken(token)
activate TS
TS -> BD: SELECT * FROM token\nWHERE token = ? AND expiresAt > NOW()
activate BD
BD --> TS: Token | null
deactivate BD

alt Token no existe o expiró
    TS --> AS: NotFoundException\n"Token no válido"
    AS --> AC: NotFoundException\n"Token no válido"
    AC --> C: HTTP 404\n"Token no válido"
else Token válido
    TS --> AS: tokenExists
    AS --> AC: "Código verificado correctamente.\nAhora puedes establecer tu nueva contraseña."
    AC --> C: HTTP 200\nToken válido
end

deactivate TS
deactivate AS
deactivate AC

== Fase 3: Actualización de Contraseña ==

C -> AC: POST /auth/update-password\n{UpdatePasswordWithTokenDto: token, password}
activate AC

AC -> AS: updatePasswordWithToken(updatePasswordWithTokenDto)
activate AS

AS -> TS: findByTokenWithUser(token)
activate TS
TS -> BD: SELECT token.*, user.*\nFROM token JOIN user\nWHERE token = ? AND expiresAt > NOW()
activate BD
BD --> TS: Token with User | null
deactivate BD

alt Token no válido
    TS --> AS: NotFoundException\n"Token no válido"
    AS --> AC: NotFoundException\n"Token no válido"
    AC --> C: HTTP 404\n"Token no válido"
else Token válido
    TS --> AS: tokenExists (with user)
    deactivate TS
    
    note over AS
        Hashear nueva contraseña
        usando bcrypt
    end note
    
    AS -> AS: hashPassword(password)
    
    AS -> US: save(user)
    activate US
    US -> BD: UPDATE user SET password = ?\nWHERE id = ?
    activate BD
    BD --> US: Usuario actualizado
    deactivate BD
    US --> AS: Usuario guardado
    deactivate US
    
    note over AS
        Eliminar token usado
        para evitar reutilización
    end note
    
    AS -> TS: remove(tokenId)
    activate TS
    TS -> BD: DELETE FROM token\nWHERE id = ?
    activate BD
    BD --> TS: Token eliminado
    deactivate BD
    TS --> AS: Token removido
    deactivate TS
    
    AS --> AC: "¡Contraseña actualizada exitosamente!\nYa puedes iniciar sesión con tu nueva contraseña."
    AC --> C: HTTP 200\nContraseña actualizada
end

deactivate AS
deactivate AC

note over C, EMAIL
    El usuario puede ahora usar su nueva contraseña
    para iniciar sesión en el sistema
end note

@enduml