@startuml Authentication System Class Diagram

title Sistema de Autenticación - Diagrama de Clases

!theme plain
skinparam classAttributeIconSize 0
skinparam classFontSize 10
skinparam packageStyle rectangle

package "Entities" {
    class User {
        - id: string (UUID)
        - name: string (100 chars)
        - email: string (unique, lowercase)
        - password: string (select: false)
        - age: number
        - confirmed: boolean (default: false)
        - createdAt: Date
        - updatedAt: Date
        - deletedAt: Date
        --
        + roles: Role[]
        + tokens: Token[]
    }

    class Role {
        - id: string (UUID)
        - name: string (unique, 100 chars)
        - description: string
        --
        + users: User[]
    }

    class Token {
        - id: string (UUID)
        - token: string (6 chars)
        - userId: string (UUID)
        - createdAt: Date
        - expiresAt: Date (default: +10 min)
        --
        + user: User
    }
}

package "Controllers" {
    class AuthController {
        - authService: AuthService
        - authEmailService: AuthEmailService
        --
        + createAccount(registerDto: RegisterDto)
        + confirmAccount(confirmAccountDto: ConfirmAccountDto)
        + login(loginDto: LoginDto)
        + requestConfirmationCode(dto: RequestConfirmationCodeDto)
        + forgotPassword(forgotPasswordDto: ForgotPasswordDto)
        + validateToken(validateTokenDto: ValidateTokenDto)
        + updatePasswordWithToken(dto: UpdatePasswordWithTokenDto)
        + getUser(req: Request)
        + updateProfile(req: Request, dto: UpdateProfileDto)
        + updateCurrentUserPassword(req: Request, dto: UpdateCurrentUserPasswordDto)
        + checkPassword(req: Request, dto: CheckPasswordDto)
        + testEmail()
    }

    class UsersController {
        - usersService: UsersService
        --
        + create(createUserDto: CreateUserDto)
        + findAll()
        + findOne(id: string)
        + update(id: string, updateUserDto: UpdateUserDto)
        + remove(id: string)
    }

    class RolesController {
        - rolesService: RolesService
        --
        + create(createRoleDto: CreateRoleDto)
        + findAll()
        + findOne(id: string)
        + update(id: string, updateRoleDto: UpdateRoleDto)
        + remove(id: string)
    }

    class TokensController {
        - tokensService: TokensService
        --
        + create(createTokenDto: CreateTokenDto)
        + findAll()
        + findOne(id: string)
        + update(id: string, updateTokenDto: UpdateTokenDto)
        + remove(id: string)
    }
}

package "Services" {
    class AuthService {
        - usersService: UsersService
        - tokensService: TokensService
        - jwtService: JwtService
        - authEmailService: AuthEmailService
        - jwtUtilService: JwtUtilService
        --
        + register(registerDto: RegisterDto)
        + confirmAccount(confirmAccountDto: ConfirmAccountDto)
        + login(loginDto: LoginDto)
        + requestConfirmationCode(dto: RequestConfirmationCodeDto)
        + forgotPassword(forgotPasswordDto: ForgotPasswordDto)
        + validateToken(validateTokenDto: ValidateTokenDto)
        + updatePasswordWithToken(dto: UpdatePasswordWithTokenDto)
        + getUser(userId: string)
        + updateProfile(userId: string, dto: UpdateProfileDto)
        + updateCurrentUserPassword(userId: string, dto: UpdateCurrentUserPasswordDto)
        + checkPassword(userId: string, dto: CheckPasswordDto)
    }

    class UsersService {
        - userRepository: Repository<User>
        --
        + create(createUserDto: CreateUserDto): Promise<User>
        + findAll(): Promise<User[]>
        + findOne(id: string): Promise<User>
        + findByEmail(email: string): Promise<User>
        + findByEmailWithPassword(email: string): Promise<User>
        + findByIdWithPassword(id: string): Promise<User>
        + save(user: User): Promise<User>
        + update(id: string, updateUserDto: UpdateUserDto): Promise<User>
        + remove(id: string): Promise<void>
    }

    class RolesService {
        - roleRepository: Repository<Role>
        --
        + create(createRoleDto: CreateRoleDto): Promise<Role>
        + findAll(): Promise<Role[]>
        + findOne(id: string): Promise<Role>
        + update(id: string, updateRoleDto: UpdateRoleDto): Promise<Role>
        + remove(id: string): Promise<void>
    }

    class TokensService {
        - tokenRepository: Repository<Token>
        --
        + create(createTokenDto: CreateTokenDto): Promise<Token>
        + findAll(): Promise<Token[]>
        + findOne(id: string): Promise<Token>
        + findByToken(token: string): Promise<Token>
        + findByTokenWithUser(token: string): Promise<Token>
        + update(id: string, updateTokenDto: UpdateTokenDto): Promise<Token>
        + remove(id: string): Promise<void>
    }

    class AuthEmailService {
        - mailerService: MailerService
        - configService: ConfigService
        --
        + sendConfirmationEmail(user: IEmailData): Promise<void>
        + sendPasswordResetToken(user: IEmailData): Promise<void>
    }

    class JwtUtilService {
        - jwtService: JwtService
        --
        + generateJWT(payload: any): string
        + verifyJWT(token: string): any
    }
}

package "Guards" {
    class AuthGuard {
        - jwtService: JwtService
        --
        + canActivate(context: ExecutionContext): Promise<boolean>
        - extractTokenFromHeader(request: any): string
    }
}

package "DTOs" {
    package "Auth DTOs" {
        class RegisterDto {
            + name: string @IsString @MinLength(1)
            + email: string @IsEmail
            + password: string @IsString @MinLength(6)
            + age: number @IsNumber
        }

        class LoginDto {
            + email: string @IsEmail
            + password: string @IsString @MinLength(6)
        }

        class ConfirmAccountDto {
            + token: string @IsString @Length(6,6)
        }

        class RequestConfirmationCodeDto {
            + email: string @IsEmail
        }

        class ForgotPasswordDto {
            + email: string @IsEmail
        }

        class ValidateTokenDto {
            + token: string @IsString @Length(6,6)
        }

        class UpdatePasswordWithTokenDto {
            + token: string @IsString @Length(6,6)
            + password: string @IsString @MinLength(6)
        }

        class UpdateProfileDto {
            + name: string @IsString @MinLength(1)
            + email: string @IsEmail
        }

        class UpdateCurrentUserPasswordDto {
            + current_password: string @IsString @MinLength(6)
            + password: string @IsString @MinLength(6)
        }

        class CheckPasswordDto {
            + password: string @IsString @MinLength(6)
        }
    }

    package "User DTOs" {
        class CreateUserDto {
            + name: string
            + email: string
            + password: string
            + age: number
        }

        class UpdateUserDto {
            + name?: string
            + email?: string
            + age?: number
        }
    }

    package "Role DTOs" {
        class CreateRoleDto {
            + name: string
            + description?: string
        }

        class UpdateRoleDto {
            + name?: string
            + description?: string
        }
    }

    package "Token DTOs" {
        class CreateTokenDto {
            + token: string
            + userId: string
        }

        class UpdateTokenDto {
            + token?: string
            + userId?: string
        }
    }
}

package "Utils" {
    class AuthUtil {
        + hashPassword(password: string): Promise<string>
        + checkPassword(password: string, hash: string): Promise<boolean>
    }

    class TokenUtil {
        + generateToken(): string
    }

    class JwtUtil {
        + generateJWT(payload: any): string
        + verifyJWT(token: string): any
    }
}

package "Interfaces" {
    interface IEmailData {
        + email: string
        + name: string
        + token: string
    }
}

' === RELACIONES ENTRE ENTIDADES ===
User ||--o{ Token : "tiene"
User }o--o{ Role : "pertenece a"

' === RELACIONES CONTROLLERS -> SERVICES ===
AuthController --> AuthService : "usa"
AuthController --> AuthEmailService : "usa"
UsersController --> UsersService : "usa"
RolesController --> RolesService : "usa"
TokensController --> TokensService : "usa"

' === RELACIONES SERVICES -> SERVICES ===
AuthService --> UsersService : "usa"
AuthService --> TokensService : "usa"
AuthService --> AuthEmailService : "usa"
AuthService --> JwtUtilService : "usa"

' === RELACIONES SERVICES -> ENTITIES ===
UsersService --> User : "gestiona"
RolesService --> Role : "gestiona"
TokensService --> Token : "gestiona"

' === RELACIONES GUARDS ===
AuthGuard --> JwtService : "usa"
AuthController ..> AuthGuard : "protegido por"

' === RELACIONES UTILS ===
AuthService --> AuthUtil : "usa"
AuthService --> TokenUtil : "usa"
JwtUtilService --> JwtUtil : "usa"

' === RELACIONES DTOs ===
AuthController ..> RegisterDto : "recibe"
AuthController ..> LoginDto : "recibe"
AuthController ..> ConfirmAccountDto : "recibe"
AuthController ..> RequestConfirmationCodeDto : "recibe"
AuthController ..> ForgotPasswordDto : "recibe"
AuthController ..> ValidateTokenDto : "recibe"
AuthController ..> UpdatePasswordWithTokenDto : "recibe"
AuthController ..> UpdateProfileDto : "recibe"
AuthController ..> UpdateCurrentUserPasswordDto : "recibe"
AuthController ..> CheckPasswordDto : "recibe"

UsersController ..> CreateUserDto : "recibe"
UsersController ..> UpdateUserDto : "recibe"

RolesController ..> CreateRoleDto : "recibe"
RolesController ..> UpdateRoleDto : "recibe"

TokensController ..> CreateTokenDto : "recibe"
TokensController ..> UpdateTokenDto : "recibe"

' === RELACIONES INTERFACES ===
AuthEmailService ..> IEmailData : "usa"

note top of User
**Entidad principal del sistema**
- UUID como clave primaria
- Email único y en minúsculas
- Password oculto por defecto (select: false)
- Soft delete con deletedAt
- Relación Many-to-Many con Roles
- Relación One-to-Many con Tokens
end note

note top of Token
**Tokens de seguridad**
- Token de 6 dígitos
- Expiración automática (10 min)
- Cascada de eliminación con User
- Usado para confirmación y reset
end note

note top of AuthService
**Servicio principal de autenticación**
- Maneja registro, login, confirmación
- Gestión de tokens de seguridad
- Integración con email y JWT
- Validaciones de negocio
end note

note top of AuthGuard
**Guard de seguridad JWT**
- Protege endpoints autenticados
- Extrae y valida tokens JWT
- Añade usuario al request
- Implementa CanActivate
end note

@enduml