@startuml account-confirmation-sequence-diagram
!theme plain
title Diagrama de Secuencia - Solicitar C√≥digo y Confirmar Cuenta

actor Cliente as C
participant "AuthController" as AC
participant "AuthService" as AS
participant "UsersService" as US
participant "TokensService" as TS
participant "AuthEmailService" as AES
database "Base de Datos" as BD
participant "Servicio de Email\n(SMTP)" as EMAIL

note over C, EMAIL
    Flujo para solicitar c√≥digo de confirmaci√≥n y confirmar cuenta
    Incluye: reenv√≠o de c√≥digo y confirmaci√≥n con email de bienvenida
end note

== Fase 1: Solicitud de C√≥digo de Confirmaci√≥n ==

C -> AC: POST /auth/request-code\n{RequestConfirmationCodeDto: email}
activate AC

AC -> AS: requestConfirmationCode(requestConfirmationCodeDto)
activate AS

note over AS
    Extraer email del DTO
end note

AS -> US: findByEmail(email)
activate US
US -> BD: SELECT * FROM user\nWHERE email = ?
activate BD
BD --> US: User | null
deactivate BD
US --> AS: user
deactivate US

alt user == null
    AS --> AC: NotFoundException\n"El Usuario no existe"
    AC --> C: HTTP 404\n"El Usuario no existe"
else user.confirmed == true
    AS --> AC: BadRequestException\n"El Usuario ya est√° confirmado"
    AC --> C: HTTP 400\n"El Usuario ya est√° confirmado"
else Usuario v√°lido y no confirmado
    
    note over AS
        Generar nuevo token de confirmaci√≥n
        de 6 d√≠gitos aleatorio
    end note
    
    AS -> AS: generateToken()
    AS -> TS: create({token, userId})
    activate TS
    TS -> BD: INSERT INTO token\n(token, userId, createdAt, expiresAt)
    activate BD
    
    note over TS, BD
        Token expira en 10 minutos
        Se pueden generar m√∫ltiples tokens
        (los anteriores siguen v√°lidos hasta expirar)
    end note
    
    BD --> TS: Token creado
    deactivate BD
    TS --> AS: tokenRecord
    deactivate TS
    
    AS -> AES: sendConfirmationEmail({email, name, token})
    activate AES
    
    note over AES
        Generar template HTML de confirmaci√≥n
        con token incluido y enlace de activaci√≥n
    end note
    
    AES -> EMAIL: Enviar email de confirmaci√≥n
    activate EMAIL
    
    note over EMAIL
        Asunto: "‚ú® Confirma tu cuenta - Taller de T√≠tulo"
        Contenido: Token de 6 d√≠gitos
        y enlace de confirmaci√≥n
    end note
    
    EMAIL --> AES: Email enviado
    deactivate EMAIL
    AES --> AS: Email confirmaci√≥n enviado
    deactivate AES
    
    AS --> AC: "Nuevo c√≥digo de verificaci√≥n enviado.\nRevisa tu email y completa la\nconfirmaci√≥n de tu cuenta."
    AC --> C: HTTP 200\nC√≥digo enviado
end

deactivate AS
deactivate AC

== Fase 2: Confirmaci√≥n de Cuenta ==

C -> AC: POST /auth/confirm-account\n{ConfirmAccountDto: token}
activate AC

AC -> AS: confirmAccount(confirmAccountDto)
activate AS

note over AS
    Extraer token del DTO
    (6 caracteres exactos)
end note

AS -> TS: findByTokenWithUser(token)
activate TS
TS -> BD: SELECT token.*, user.*\nFROM token JOIN user\nWHERE token = ? AND expiresAt > NOW()
activate BD
BD --> TS: Token with User | null
deactivate BD

alt Token no v√°lido o expirado
    TS --> AS: NotFoundException\n"Token no v√°lido"
    AS --> AC: NotFoundException\n"Token no v√°lido"
    AC --> C: HTTP 404\n"Token no v√°lido"
else Token v√°lido
    TS --> AS: tokenExists (with user)
    deactivate TS
    
    note over AS
        Marcar usuario como confirmado
        en la base de datos
    end note
    
    AS -> AS: user.confirmed = true
    
    AS -> US: save(user)
    activate US
    US -> BD: UPDATE user SET confirmed = true\nWHERE id = ?
    activate BD
    BD --> US: Usuario actualizado
    deactivate BD
    US --> AS: Usuario guardado
    deactivate US
    
    note over AS
        Eliminar token usado
        para evitar reutilizaci√≥n
    end note
    
    AS -> TS: remove(tokenId)
    activate TS
    TS -> BD: DELETE FROM token\nWHERE id = ?
    activate BD
    BD --> TS: Token eliminado
    deactivate BD
    TS --> AS: Token removido
    deactivate TS
    
    note over AS
        Enviar email de bienvenida
        para notificar confirmaci√≥n exitosa
    end note
    
    AS -> AES: sendWelcomeEmail({email, name})
    activate AES
    
    note over AES
        Generar template HTML de bienvenida
        sin token, solo informaci√≥n de bienvenida
    end note
    
    AES -> EMAIL: Enviar email de bienvenida
    activate EMAIL
    
    note over EMAIL
        Asunto: "üéâ ¬°Bienvenido a Taller de T√≠tulo!"
        Contenido: Mensaje de bienvenida
        y enlaces √∫tiles de la plataforma
    end note
    
    EMAIL --> AES: Email enviado
    deactivate EMAIL
    AES --> AS: Email bienvenida enviado
    deactivate AES
    
    AS --> AC: "¬°Cuenta confirmada exitosamente!\nAhora puedes acceder a todas las\nfuncionalidades de la plataforma."
    AC --> C: HTTP 200\nCuenta confirmada
end

deactivate AS
deactivate AC

note over C, EMAIL
    El usuario puede ahora iniciar sesi√≥n
    con acceso completo a todas las funcionalidades
    de la plataforma
end note

@enduml